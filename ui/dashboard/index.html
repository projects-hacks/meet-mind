<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MeetMind Local Dashboard</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #131a2e;
        --panel-2: #1a2340;
        --text: #e8ecff;
        --muted: #93a0c5;
        --ok: #65d6a6;
        --warn: #ffbe55;
        --danger: #ff7a7a;
        --accent: #8ea2ff;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
        color: var(--text);
        background: radial-gradient(circle at top left, #1a2350 0%, var(--bg) 35%);
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #29325b;
        background: rgba(11, 16, 32, 0.75);
        position: sticky;
        top: 0;
        backdrop-filter: blur(8px);
      }
      .badge {
        background: #1f2a4e;
        color: var(--ok);
        border: 1px solid #33508f;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
      }
      main {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        padding: 12px;
      }
      .card {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid #2b3767;
        border-radius: 12px;
        padding: 12px;
        min-height: 180px;
      }
      h2 {
        margin: 0 0 10px;
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.4px;
        text-transform: uppercase;
      }
      pre, ul {
        margin: 0;
        padding-left: 18px;
        font-size: 13px;
        line-height: 1.45;
      }
      pre { white-space: pre-wrap; padding-left: 0; }
      .full { grid-column: 1 / -1; }
      .actions {
        display: flex;
        gap: 8px;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }
      .status-ok { background: var(--ok); }
      .status-warn { background: var(--warn); }
      .status-down { background: var(--danger); }
      button {
        background: #28386d;
        color: var(--text);
        border: 1px solid #3a54a0;
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
        font-weight: 600;
      }
      button:hover { filter: brightness(1.1); }
      .muted { color: var(--muted); }
      @media (max-width: 980px) {
        main { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <div><strong>MeetMind</strong> Local Dashboard</div>
        <div id="meta" class="muted">Loading...</div>
        <div class="muted"><span id="connDot" class="status-dot status-warn"></span><span id="connText">Connecting to local SSE...</span></div>
      </div>
      <div class="actions">
        <span class="badge">LOCAL 路 ON DEVICE</span>
        <button id="sampleBtn">Sample Perception</button>
        <button id="summaryBtn">Generate Summary</button>
        <button id="resetBtn">Reset Session</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>System Health</h2>
        <pre id="health"></pre>
      </section>
      <section class="card">
        <h2>Last Cycle Result</h2>
        <pre id="cycleResult"></pre>
      </section>
      <section class="card">
        <h2>Key Points</h2>
        <ul id="keyPoints"></ul>
      </section>
      <section class="card">
        <h2>Action Items</h2>
        <ul id="actionItems"></ul>
      </section>
      <section class="card">
        <h2>Decisions</h2>
        <ul id="decisions"></ul>
      </section>
      <section class="card">
        <h2>Gaps</h2>
        <ul id="gaps"></ul>
      </section>
      <section class="card">
        <h2>Suggestions</h2>
        <ul id="suggestions"></ul>
      </section>
      <section class="card">
        <h2>Insights</h2>
        <ul id="insights"></ul>
      </section>
      <section class="card">
        <h2>Timeline</h2>
        <ul id="timeline"></ul>
      </section>
      <section class="card">
        <h2>Whiteboard</h2>
        <pre id="whiteboard"></pre>
      </section>
      <section class="card full">
        <h2>Artifact Viewer</h2>
        <ul id="artifacts"></ul>
      </section>
      <section class="card full">
        <h2>Latest Generated Artifact Content</h2>
        <pre id="artifactContent" class="muted">No generated artifact content yet</pre>
      </section>
    </main>

    <script>
      const q = (id) => document.getElementById(id);
      const api = {
        summary: '/api/summary',
        reset: '/api/reset',
        sample: '/api/perceptions/sample',
        health: '/api/health',
        generateSummary: '/api/artifacts/meeting-summary',
        stream: '/api/stream'
      };

      let eventSource = null;

      function renderList(el, items, fmt) {
        el.innerHTML = '';
        if (!items || !items.length) {
          el.innerHTML = '<li class="muted">No items yet</li>';
          return;
        }
        for (const item of items) {
          const li = document.createElement('li');
          li.textContent = fmt ? fmt(item) : String(item);
          el.appendChild(li);
        }
      }

      function render(summary) {
        const mode = summary.air_gapped ? 'AIR-GAPPED' : 'LOCAL';
        const lastAction = summary.last_action?.action || 'none';
        q('meta').textContent = `${summary.topic || 'Unknown'} 路 ${summary.domain || 'general'} 路 ${mode} 路 last action ${lastAction} 路 avg cycle ${summary.avg_cycle_time || 0}s`;
        renderList(q('keyPoints'), summary.key_points || []);
        renderList(q('actionItems'), summary.action_items || [], (a) => `${a.owner}: ${a.task} (${a.deadline})`);
        renderList(q('decisions'), summary.decisions || [], (d) => d.decision);
        renderList(q('gaps'), summary.gaps || [], (g) => `${g.topic} [${g.gap_type}]`);
        renderList(q('suggestions'), summary.suggestions || [], (s) => s.replace(/^\s*/, ''));
        renderList(q('insights'), summary.insights || [], (i) => i.replace(/^\s*/, ''));
        renderList(q('timeline'), summary.timeline || [], (t) => `${t.time || '--'} 路 ${t.content || ''}`);
        q('whiteboard').textContent = summary.whiteboard || 'No whiteboard summary yet';
        renderList(
          q('artifacts'),
          summary.artifacts || [],
          (a) => `${a.type || 'artifact'} 路 ${a.status || 'pending'}${a.source ? ` 路 ${a.source}` : ''}${a.context ? ` 路 ${a.context}` : ''}`
        );
      }

      function setConnection(connected) {
        q('connDot').className = `status-dot ${connected ? 'status-ok' : 'status-down'}`;
        q('connText').textContent = connected ? 'Local stream connected' : 'Local stream disconnected';
      }

      async function fetchSummary() {
        const res = await fetch(api.summary);
        if (!res.ok) return;
        render(await res.json());
      }

      async function fetchHealth() {
        const res = await fetch(api.health);
        if (!res.ok) return;
        const data = await res.json();
        q('health').textContent = JSON.stringify(data.health || {}, null, 2);
      }

      function connectSSE() {
        if (eventSource) {
          eventSource.close();
        }

        eventSource = new EventSource(api.stream);
        eventSource.onopen = () => setConnection(true);
        eventSource.onerror = () => {
          setConnection(false);
          setTimeout(connectSSE, 1500);
        };

        eventSource.addEventListener('summary', (evt) => {
          try { render(JSON.parse(evt.data)); } catch (_) {}
        });

        eventSource.addEventListener('cycle_result', (evt) => {
          try { q('cycleResult').textContent = JSON.stringify(JSON.parse(evt.data), null, 2); } catch (_) {}
          fetchSummary();
          fetchHealth();
        });

        eventSource.addEventListener('artifact', (evt) => {
          try {
            const a = JSON.parse(evt.data);
            q('artifactContent').textContent = a.content || 'No artifact content';
          } catch (_) {}
          fetchSummary();
        });
      }

      q('resetBtn').addEventListener('click', async () => {
        await fetch(api.reset, { method: 'POST' });
        q('artifactContent').textContent = 'No generated artifact content yet';
        q('cycleResult').textContent = '{}';
        fetchHealth();
      });

      q('sampleBtn').addEventListener('click', async () => {
        await fetch(api.sample, { method: 'POST' });
      });

      q('summaryBtn').addEventListener('click', async () => {
        const res = await fetch(api.generateSummary, { method: 'POST' });
        if (res.ok) {
          const payload = await res.json();
          q('artifactContent').textContent = payload.content || 'No artifact content';
          fetchSummary();
        }
      });

      fetchSummary();
      fetchHealth();
      connectSSE();
      setInterval(fetchHealth, 5000);
    </script>
  </body>
</html>
